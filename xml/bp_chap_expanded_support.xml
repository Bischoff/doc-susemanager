<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook50-profile.xsl"
                 type="text/xml" 
                 title="Profiling step"?>
<!DOCTYPE chapter
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
    %entities;
]>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="mgr.expanded.support">
    <title>Expanded Support</title>
    <para/>
    <sect1>
        <title>Managing RES Clients</title>
        <para>The following sections provide guidance on managing Red Hat Expanded Support clients,
            this includes salt-minions and traditional systems. </para>

        <sect2>
            <title>Server Configuration for RES Channels</title>
            <para>This section provides guidance on server configuration for RES Channels provided
                by SUSE.</para>
            <itemizedlist>
                <listitem>
                    <para>Minimum of 8GB ram and at least two physical CPU or virtual CPU's.
                        Taskomatic will use 1 of these CPUs</para>
                </listitem>
                <listitem>
                    <para>Taskomatic requires of minimum of 3072MB Ram. This should be set in
                            <filename>/etc/rhn/rhn.conf</filename>:</para>
                    <screen>taskomatic.java.maxmemory=3072</screen>
                </listitem>
                <listitem>
                    <para>Provision enough disk space. <filename>/var/spacewalk</filename> contains
                        all mirrored RPMs. For example: RES 6 x86_64 channels require 90GB+ </para>
                </listitem>
                <listitem>
                    <para>LVM or an NFS mount is recommended</para>
                </listitem>
                <listitem>
                    <para>Access to RHEL 5/6/7 Subscription Media</para>
                </listitem>
            </itemizedlist>
            <warning>
                <title>Access to RHEL Media/repositories</title>
                <para>Access to Red Hat base media repositories and RHEL installation media is the
                    responsibility of our customers. Ensure that all your RHEL systems obtain
                    support from RHEL, or alternatively all your RHEL systems obtain support from
                    SUSE. If you do not follow these practices you may violate terms with Red
                    Hat.</para>
            </warning>
        </sect2>

        <sect2>
            <title>RES Channel Management Tips</title>
            <para>This section provides tips on RES channel management.</para>
            <itemizedlist>
                <listitem>
                    <para>The base parent distribution/architecture RES channel contains zero
                        packages. No base media is provided by SUSE. The RHEL media or installation
                        ISOs should be added as child channels of the RES parent channel.</para>
                </listitem>
                <listitem>
                    <para>The RES and tools channels are provided by SUSE Customer Center(SCC) using
                            <literal>mgr-sync</literal></para>
                </listitem>
                <listitem>
                    <para>It can take up to or more than 24 hours for an initial channel
                        sync.</para>
                </listitem>
                <listitem>
                    <para>Once you have completed the initial sync process of any RES channel it is
                        recommended to clone the channel before working with it. This provides you
                        with a backup of the original sync.</para>
                </listitem>
            </itemizedlist>
        </sect2>

        <sect2>
            <title>Mirroring RHEL Media into a Channel</title>
            <para>The following procedure guides you through setup of the RHEL media as a SUSE
                Manager channel. All packages on the RHEL media will be mirrored into a child
                channel located under RES 5/6/7 distribution/architecture.</para>

            <procedure>
                <title>Mirroring RHEL Media into a Channel</title>
                <step>
                    <para>Create a new Channel by logging into the WebUI and selecting
                            <guimenu>Channels</guimenu> &gt; <guimenu>Manage Software
                            Channels</guimenu> &gt; <guimenu>Create Channel. </guimenu></para>
                </step>
                <step>
                    <para>Fill in basic channel details and add the channel as a child to the
                        corresponding RES 5/6/7 distribution/architecture channel from Customer
                        Center. The base parent channel should contain zero packages.</para>
                </step>
                <step>
                    <para>Modify the RES 5/6/7 activation key to include this new child
                        channel</para>
                </step>
                <step>
                    <para>As root on the SUSE Manager command line copy the ISO to
                            <filename>/tmp</filename> directory.</para>
                </step>
                <step>
                    <para>Create a directory to contain the media content:</para>
                    <screen># mkdir -p /srv/www/htdocs/pub/rhel</screen>
                </step>
                <step>
                    <para>Mount the ISO:</para>
                    <screen># mount -o loop /tmp/name_of_iso /srv/www/htdocs/pub/rhel</screen>
                </step>
                <step>
                    <para>Start spacewalk-repo-sync to sync packages:</para>
                    <screen># spacewalk-repo-sync -c channel_name -u https://127.0.0.1/pub/rhel/Server/
Repo URL: https://127.0.0.1/pub/rhel/Server/
Packages in repo:              3690
Packages already synced:          0
Packages to sync:              3690
1/3690 : texlive-latex-2007-57.el6_2-0.x86_64
2/3690 : boost-filesystem-1.41.0-18.el6-0.i686
3/3690 : policycoreutils-newrole-2.0.83-19.39.el6-0.x86_64
[...]</screen>
                </step>
                <step>
                    <para>Once the channel has completed the sync process you can utilize the
                        channel as any normal SUSE Manager channel.</para>
                </step>
            </procedure>
        </sect2>

        <sect2>
            <title>Registering RES salt-minions with SUSE Manager</title>
            <para>This section will guide you through registering RHEL minions with SUSE Manager.
                This section assumes you have updated your server to the latest patch level</para>

            <sect3>

                <title> Syncing Appropriate RES Channels</title>
                <para>Ensure you have the corresponding RES product enabled and required channels
                    have been fully synced:</para>

                <itemizedlist>
                    <title>RHEL 7.x</title>
                    <listitem>
                        <para>- Product: RES 7</para>
                    </listitem>
                    <listitem>
                        <para>- Mandatory channels: rhel-x86_64-server-7,
                            res7-suse-manager-tools-x86_64, res7-x86_64</para>
                    </listitem>
                </itemizedlist>

                <itemizedlist>
                    <title>RHEL 6.x</title>
                    <listitem>
                        <para>- Product: RES 6</para>
                    </listitem>
                    <listitem>
                        <para>- Mandatory channels: rhel-x86_64-server-6,
                            res6-suse-manager-tools-x86_64, res6-x86_64</para>
                    </listitem>
                </itemizedlist>
                <tip>
                    <title>Checking Sync Progress</title>
                    <para>To check if a channel has finished syncing you can do one of the
                        following:</para>
                    <itemizedlist>
                        <listitem>
                            <para>From the SUSE Manager WebUI browse to <guimenu>Admin</guimenu> >
                                    <guimenu>Setup Wizard</guimenu> and select the <guimenu>SUSE
                                    Products</guimenu> tab. Here you will find a percent completion
                                bar for each product.</para>
                        </listitem>
                        <listitem>
                            <para>Alternatively you may check the sync log file located under
                                    <filename>/var/log/rhn/reposync/&lt;channel-label&gt;.log</filename>
                                using cat or the tailf command. Keep in mind that base channels can
                                contain multiple child channels. Each of these child channels will
                                generate its own log during the sync progress. Do not assume a
                                channel has finished syncing until you have checked all relevant log
                                files including base and child channels.</para>
                        </listitem>
                    </itemizedlist>
                </tip>

                <para>Create an activation key associated with the RES channel.</para>
            </sect3>

            <sect3>
                <title>Creating a Bootstrap Repository</title>
                <para>The following procedure demonstrate creating a bootstrap repository for
                    RHEL</para>
                <procedure>
                    <step>
                        <para>On the server command line as root, create a bootstrap repo for RHEL
                            with the following command :</para>
                        <screen>mgr-create-bootstrap-repo RHEL_activation_channel_key</screen>
                        <para>If required, recreate the bootstrap script with the Salt option
                            enabled:</para>
                        <screen>mgr-bootstrap --salt</screen>
                    </step>
                    <step>
                        <para>Rename bootstrap.sh to resversion-boostrap.sh:</para>
                        <screen># cp bootstrap.sh res7-bootstrap.sh</screen>
                    </step>
                </procedure>

            </sect3>


        </sect2>

        <sect2>
            <title>Register a Salt Minion via Bootstrap</title>
            <para>The following procedure will guide you through registering a Salt-minion using the
                bootstrap script.</para>
            <procedure>
                <title> Registration Using the Bootstrap Script </title>
                <step>
                    <para>From your new minion download the bootstrap script from the SUSE Manager
                        server:</para>
                    <screen>wget --no-check-certificate https://&lt;server&gt;/pub/bootstrap/res7-bootstrap.sh</screen>
                </step>
                <step>
                    <para>Add the appropriate res-gpg-pubkey-#####-#####.key to the
                            <literal>ORG_GPG_KEY</literal> key parameter, comma delimited in your
                        res7-bootstrap.sh script. These are located on your SUSE Manager server
                        at:</para>
                    <screen>http://(FDQN)/pub/</screen>
                </step>
                <step>
                    <para>Make the bootstrap.sh script executable and run it. This will install
                        necessary Salt packages from the bootstrap repository and start the
                        salt-minion service:</para>
                    <screen># chmod +x res7-bootstrap.sh
# ./res7-boostrap.sh</screen>
                </step>
                <step>
                    <para>From the SUSE Manager WebUI select the <guimenu>Salt</guimenu> >
                            <guimenu>Onboarding</guimenu> and accept the new minions key.</para>
                </step>
            </procedure>

            <important>
                <title>Troubleshooting Bootstrap</title>
                <para>If you have issues bootstrapping a minion its usually due to missing packages.
                    These missing packages are contained on the RHEL installation media. The RHEL
                    installation media should be loop mounted and added as a child channel to the
                    RES channel. See the warning above on access to RHEL Media.</para>
            </important>
        </sect2>

        <sect2>
            <title>Manual Salt-minion Registration</title>
            <para>The following procedure will guide you through the registration of a Salt-minion
                manually.</para>
            <procedure>
                <step>
                    <para>Add the bootstrap repository:</para>
                    <screen>yum-config-manager --add-repo https://&lt;server&gt;/pub/repositories/res/7/bootstrap</screen>
                </step>
                <step>
                    <para>Install the salt-minion package:</para>
                    <screen># yum install salt-minion</screen>
                </step>
                <step>
                    <para>Edit the salt-minion configuration file to point to the SUSE manager
                        server:</para>
                    <screen># mkdir /etc/salt/minion.d
# echo "master: &lt;server fqdn&gt;" &gt; /etc/salt/minion.d/susemanager.conf </screen>
                </step>
                <step>
                    <para>Start the minion service:</para>
                    <screen># systemctl start salt-minion</screen>
                </step>
                <step>
                    <para>From the SUSE Manager WebUI select the <guimenu>Salt</guimenu> >
                            <guimenu>Onboarding</guimenu> and accept the new minions key.</para>
                </step>
            </procedure>
        </sect2>
    </sect1>

    <sect1>
        <title>Managing CentOS Expanded Support Clients (RES)</title>
        <para>The following sections will guide you through preparing CentOS channels and
            repositories for bootstrapping CentOS clients to SUSE Manager.</para>

        <sect2>
            <title>Creating Channels and Repositories</title>
            <para>Create the repositories for CentOS.</para>
            <procedure>
                <title>Adding the Base repository</title>
                <step>
                    <para>Login to your SUSE Manager WebUI and browse to:
                            <guimenu>Channels</guimenu> &gt; <guimenu>Manage Software
                            Channels</guimenu> &gt; <guimenu>Manage Repositories</guimenu> and
                        select <guimenu>Create New Repository</guimenu></para>
                </step>
                <step>
                    <para>Add the Base repository details:</para>
                    <screen>Repository label: CentOS 6 Base x86_64
Repository URL: http://mirrors.kernel.org/centos/6/os/x86_64/

Has signed metadata? UNCHECKED</screen>
                </step>
                <step>
                    <para>Repeat previous steps and create the updates repository:</para>
                    <screen>Repository label: CentOS 6 updates x86_64
Repository URL: http://mirrors.kernel.org/centos/6/updates/x86_64/
(or your preferred mirror)

Has signed metadata? UNCHECKED</screen>
                </step>
            </procedure>


        </sect2>

        <sect2>
            <title>Creating CentOS Channels</title>
            <para>Create the CentOS channels.</para>
            <procedure>
                <title>Creating the CentOS Channels</title>
                <step>
                    <para>Login to your SUSE Manager WebUI and browse to:
                            <guimenu>Channels</guimenu> &gt; <guimenu>Manage Software
                            Channels</guimenu> &gt; <guimenu>Create New Channel</guimenu></para>
                </step>
                <step>
                    <para>Add the following base channel details:</para>
                    <screen>Channel Name*: CentOS 6 Base - x86_64
Channel Label*: centos6-base-x86_64
Parent Channel: None
Architecture: x86_64
Repository Checksum Type: sha1

Channel Summary, etc: fill as desired

GPG key URL: http://mirrors.kernel.org/centos/6/os/x86_64/RPM-GPG-KEY-CentOS-6
GPG key ID: C105B9DE
GPG key Fingerprint: C1DA C52D 1664 E8A4 386D BA43 0946 FCA2 C105 B9DE</screen>
                </step>
                <step>
                    <para>Repeat the previous steps and create the updates child channel</para>
                    <screen>Channel Name*: CentOS 6 Updates - x86_64
Channel Label*: centos6-updates-x86_64
Parent Channel: CentOS 6 Base - x86_64
Architecture: x86_64
Repository Checksum Type: sha1

Channel Summary, etc: fill as desired

GPG key URL: http://mirrors.kernel.org/centos/6/os/x86_64/RPM-GPG-KEY-CentOS-6
GPG key ID: C105B9DE
GPG key Fingerprint: C1DA C52D 1664 E8A4 386D BA43 0946 FCA2 C105 B9DE</screen>
                </step>
            </procedure>

        </sect2>

        <sect2>
            <title>Adding the Repositories to the New Channels</title>
            <para>Add the repositories to your new channels.</para>
            <procedure>
                <title>Add Repositories to Channels</title>
                <step>
                    <para>Login to your SUSE Manager WebUI and browse to:
                            <guimenu>Channels</guimenu> &gt; <guimenu>Manage Software
                            Channels</guimenu> and click the <guimenu>CentOS Base channel</guimenu>
                        created previously.</para>
                </step>
                <step>
                    <para/>
                    <para>Select the <guimenu>Repositories</guimenu> tab and select the CentOS base
                        repository.</para>
                </step>
                <step>
                    <para>Now add the updates repository to the updates child channel. Browse to
                            <guimenu>Channels</guimenu> &gt; <guimenu>Manage Software
                            Channels</guimenu> and select the <guimenu>CentOS Updates
                            Channel</guimenu> created previously.</para>
                </step>
                <step>
                    <para>Select the <guimenu>Repositories</guimenu> tab and select the CentOS
                        updates repository.</para>
                </step>
                <step>
                    <para>You may optionally force a sync of channel packages by clicking the
                            <guimenu>Sync</guimenu>.</para>
                </step>
                <step>
                    <para>Once you have completed syncing the Updates and Base CentOS channels you
                        should see an estimated 6000+ packages for the base channel and a few
                        hundred for the updates channel. The next section will cover registering
                        CentOS clients.</para>
                </step>
            </procedure>

        </sect2>

        <sect2>
            <title>Registering CentOS salt-minions with SUSE Manager</title>
            <para>The following procedure will guide you through registering a CentOS Minion.</para>
            <warning>
                <title>Support for CentOS Patches</title>
                <para>Warning: CentOS utilizing patches originating from CentOS is not officially
                    supported by SUSE. Please reference the matrix of SUMA clients on the main page
                    of the SUSE Manager wiki.<link
                        xlink:href="https://wiki.microfocus.com/images/e/eb/SUMA3-client-matrix-20170509.png"
                    /></para>
            </warning>
            <procedure>
                <title>Register a CentOS 7 Minion</title>
                <step>
                    <para>Add the Open Build Service repo for Salt:</para>
                    <screen>yum-config-manager --add-repo http://download.opensuse.org/repositories/systemsmanagement:/saltstack:/products/RHEL_7/</screen>
                </step>
                <step>
                    <para>Import the repo key:</para>
                    <screen>rpm --import http://download.opensuse.org/repositories/systemsmanagement:/saltstack:/products/RHEL_7/repodata/repomd.xml.key</screen>
                </step>
                <step>
                    <para>Check if there's any other repo that contains Salt. If there's only one
                        repo listed then you're fine. If not disable any other repo that contains
                        Salt apart from the OBS one.</para>
                    <screen>yum list --showduplicates salt</screen>
                </step>
                <step>
                    <para>Install the Salt minion:</para>
                    <screen>yum install salt salt-minion</screen>
                </step>
                <step>
                    <para>Change the Salt configuration to point to the Suse Manager server:</para>
                    <screen>mkdir -p /etc/salt/minion.d
echo "master: &lt;server fqdn&gt;" &gt; /etc/salt/minion.d/susemanager.conf</screen>
                </step>
                <step>
                    <para>Restart the minion</para>
                    <screen>systemctl restart salt-minion</screen>
                </step>
                <step>
                    <para>Proceed to <menuchoice>
                            <guimenu>Salt</guimenu>
                            <guimenu>Onboarding</guimenu>
                        </menuchoice> from the WebUI and accept the minion key.</para>
                </step>
            </procedure>

        </sect2>

    </sect1>





</chapter>
