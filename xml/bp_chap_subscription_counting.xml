<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook50-profile.xsl"
                 type="text/xml" 
                 title="Profiling step"?>
<!DOCTYPE chapter
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
    %entities;
]>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="bp.subscript.management">
    <title>Subscription Management</title>

    <sect1>
        <title>The Subscription Matcher</title>
        <para>To match your Subscriptions with your systems utilize the new subscription-matcher
            tool. It gathers information about systems, subscriptions and pinned matches (fixed
            customer defined subscriptions to systems mapping) as input and returns the best
            possible match according to the SUSE Terms and Conditions. The subscription-matcher is
            also able to write some CSV Reports:<itemizedlist>
                <listitem>
                    <para>The <systemitem>Subscription Report</systemitem> provides subscriptions
                        report data when used</para>
                </listitem>
                <listitem>
                    <para>The <systemitem>Unmatched Products Report</systemitem> provides
                        information on products and their systems when a match to a subscription
                        cannot be found</para>
                </listitem>
                <listitem>
                    <para>The <systemitem>Error Report</systemitem> provides a list of errors raised
                        during the matching process </para>
                </listitem>
            </itemizedlist>
        </para>
    </sect1>
    <sect1>
        <title>Matching Subscriptions to Systems</title>

        <para>SUSE Manager 3 automatically generates up-to-date nightly status reports by matching
            your SUSE subscriptions with all your registered systems. These reports are stored in
                <replaceable>/var/lib/spacewalk/subscription-matcher</replaceable> and provided in
            CSV format. These CSV files may be opened with any mainstream spreadsheet application
            such as LibreOffice Calc. </para>

        <para>If you would like to schedule these reports to be produced at different times, or a at
            a certain frequency or schedule a one time completion you can perform this task by
            editing the Taskomatic settings for the gatherer-matcher located under Schedule name at: <menuchoice>
                <guimenu>Admin</guimenu>
                <guimenu>Task Schedules</guimenu>
                <guimenu>gatherer-matcher-default</guimenu>
            </menuchoice></para>

        <figure>
            <title>gatherer-matcher-default</title>
            <mediaobject>
                <imageobject>
                    <imagedata fileref="gatherer-matcher-default.png" width="80%"/>
                </imageobject>
            </mediaobject>
        </figure>

    </sect1>
    <sect1>
        <title>Gathering Information on Foreign Virtual Hosts</title>

        <para>A pre-requirement to match subscriptions to systems is to have complete information
            about which virtual system runs on which virtual host. SUSE Manager gets this
            information without any further configuration if the hypervisor is a registered system
            running on SUSE Linux Enterprise Server or RedHat Enterprise Linux. Third party
            hypervisors, like VMware or Hyper-V, need configuration described in this page. </para>

        <para>Third party hypervisors and hypervisor managers such as VMWare vCenter are called
            "Virtual Host Managers" (VHM) in SUSE Manager, as they are able to manage one or
            multiple virtual hosts, which in turn may contain virtual guests.</para>

        <para>SUSE Manager 3 ships with a tool (virtual-host-gatherer) that can connect to VHMs
            using their API, request information about virtual hosts. This tool is automatically
            invoked via Taskomatic every night - you just need to configure your VHMs via XMLRPC
            APIs. </para>

        <para>virtual-host-gatherer has the concept of optional modules - each module enables a
            specific Virtual Host Manager "type" to be used (eg. VMware). </para>
    </sect1>

    <sect1>
        <title>Available virtual-host-gatherer Modules</title>
        <para><itemizedlist>
                <listitem>
                    <para>VMWare: supports VMware products running on the vSphere operating system,
                        currently VMware ESX, ESXi and vCenter</para>
                </listitem>
                <listitem>
                    <para>File: read data from a plain json file which could be obtained from
                        another virtual-host-gatherer instance (typically from a different
                        disconnected network which has direct access to VHMs) or created manually.
                        See the man page for a specification of the expected json format.</para>
                </listitem>
            </itemizedlist>In future more modules might be made available, for example to support
            Microsoft Hyper-V. </para>

        <sect2>
            <title>Coexistence of the virtual-ost-gatherer and Poller</title>
            <para>virtual-host-gatherer shouldn't be used for gathering the data from hypervisors
                that are registered systems in SUSE Manager (running SLES or RES). Information from
                such hypervisors is already retrieved using the poller utility and having the
                redundant information from virtual-host-gatherer may cause problems. </para>
        </sect2>
        <sect2>
            <title>Configuring Virtual Host Managers from the WebUI</title>
            <para>The Web UI for configuring the Virtual Host Managers can be found under: <menuchoice>
                    <guimenu>Systems</guimenu>
                    <guimenu>Virtual Host Managers</guimenu>
                </menuchoice></para>
            <para>If you select it, you will see a list of already configured VHMs. To add a new VHM
                you can select the links in the top right corner. E.g. Add VMware-based Virtual Host
                Manager or Add File-based Virtual Host Managers. After you selected the module, you
                see the configuration fields. Some maybe pre-filled with typical values for this
                module. </para>

            <para>The VHM is created when you click on the Add Virtual Host Manager Button. </para>

            <para>The new VHM should now be listed in the Overview page. If you click on the name,
                you can see the configuration details of this VHM and you can delete it by clicking
                on Delete Virtual Host Manager button or trigger a refresh by clicking on the
                Refresh data from this Virtual Host Manager. </para>

            <para>At the end of a successful run, you should see your Virtual Host Managers in the
                Systems list. </para>
        </sect2>

        <sect2>
            <title>Configuring Virtual Host Managers via XMLRPC API</title>
            <para>The following APIs allow you to get a list of available virtual-host-manager
                modules and the parameters they require: <itemizedlist>
                    <listitem>
                        <para> virtualhostmanager.listAvailableVirtualHostGathererModules(session)
                        </para>
                    </listitem>
                    <listitem>
                        <para>virtualhostmanager.getModuleParameters(session, moduleName)</para>
                    </listitem>
                </itemizedlist></para>
            <para>The following APIs allow you to create and delete VHMs. Take care that the module
                parameter map must match the map returned by virtualhostmanager.getModuleParameters
                to work correctly: <itemizedlist>
                    <listitem>
                        <para>virtualhostmanager.create(session, label, moduleName,
                            parameters)</para>
                    </listitem>
                    <listitem>
                        <para>virtualhostmanager.delete(session, label)</para>
                    </listitem>
                </itemizedlist></para>
            <para> The following APIs return information about configured VHMs: <itemizedlist>
                    <listitem>
                        <para>virtualhostmanager.listVirtualHostManagers(session)</para>
                    </listitem>
                    <listitem>
                        <para>virtualhostmanager.getDetail(session, label)</para>
                    </listitem>
                </itemizedlist>
            </para>
        </sect2>
    </sect1>

    <sect1>
        <title>Running virtual-host-gatherer</title>
        <para>The virtual-host-gatherer is a tool which connects to VHMs and returns information
            about the virtual hosts and virtual systems running on them. In SUSE Manager 3 there is
            an automatic Taskomatic job executing it nightly. </para>
        <para>You can manually start the virtual-host-gatherer via the WebUI as with any Taskomatic
            job by selecting: <menuchoice>
                <guimenu>Admin</guimenu>
                <guimenu>Task Schedules</guimenu>
                <guimenu>gatherer-bunch</guimenu>
                <guimenu>Single Run Schedule</guimenu>
            </menuchoice></para>
        <para>
            You may also use the Virtual Host Managers (VHM) Overview page found under:
            <menuchoice>
                <guimenu>Systems</guimenu>
                <guimenu>Virtual Host Managers</guimenu>
            </menuchoice>
        </para>
        <para>Within each item there is a <guibutton>Refresh</guibutton> which will run the virtual-host-gatherer on the current (VHM).</para>
    </sect1>
</chapter>
