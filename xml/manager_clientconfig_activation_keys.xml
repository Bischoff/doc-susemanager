<?xml version="1.0"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:novdoc-profile.xsl" 
 type="text/xml"
 title="Profiling step"?>
<!DOCTYPE chapter PUBLIC
  "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd"
[
  <!ENTITY % NOVDOC.DEACTIVATE.IDREF "INCLUDE">
  <!ENTITY % entities SYSTEM "entity-decl.ent">
  %entities;
]>
<chapter id="ch-rhnreg-ks">
 <title>Implementing and Tracking Autoinstallation</title><indexterm>
 <primary>Autoinstallation</primary>
 <secondary>use of</secondary></indexterm>
 <para>
  Once configuration is finished, register the system with the local &susemgr;, using the
  <command>rhnreg_ks</command> utility that comes with the
  <filename>spacewalk-client-setup</filename> package. This chapter
  discusses the use of <command>rhnreg_ks</command> to register systems
  and track autoinstallations.
 </para>
 <sect1 id="s1-rhnreg-ks-rhnreg-ks">
  <title>The Use of rhnreg_ks</title>
 <para>
  The <command>rhnreg_ks</command> utility uses <emphasis>activation
  keys</emphasis> to register, entitle, and subscribe systems to
  specified channels in one go. For more information about
  activation keys, refer to <xref
  linkend="s2-sm-systems-activation-keys"/>.
 </para>
 <para>
  The following commented Kickstart file is an example of how a &rhel;
  system can be configured using Kickstart.
 </para>
<screen># Generic 7.2 kickstart for laptops in the Widget Corporation (widgetco)

# Standard kickstart options for a network-based install. For an
# explanation of these options, consult the Red Hat Enterprise Linux 
# Customization Guide.

lang en_US
langsupport --default en_US en_US
keyboard defkeymap
network --bootproto dhcp
install
url --url ftp://ftp.widgetco.com/pub/redhat/linux/7.2/en/os/i386
zerombr yes
clearpart --all
part /boot   --size 128 --fstype ext3 --ondisk hda
part /       --size 2048 --grow --fstype ext3 --ondisk hda
part /backup --size 1024 --fstype ext3 --ondisk hda
part swap    --size 512 --ondisk hda
bootloader --location mbr
timezone America/New_York
rootpw --iscrypted $1$78Jnap82Hnd0PsjnC8j3sd2Lna/Hx4.
auth --useshadow --enablemd5 --krb5realm .COM --krb5kdc auth.widgetco.com \
        --krb5adminserver auth.widgetco.com
mouse --emulthree genericps/2
xconfig --card &quot;S3 Savage/MX&quot; --videoram 8192   --resolution 1024x768 \
        --depth 16 --defaultdesktop=GNOME --startxonboot --noprobe \
        --hsync 31.5-48.5 --vsync 40-70

reboot

# Define a standard set of packages.

%packages
@ Base
@ Utilities
@ GNOME
@ Laptop Support
@ Dialup Support
@ Software Development
@ Graphics and Image Manipulation
@ Games and Entertainment
@ Sound and Multimedia Support

%post
( # We run the entire %post section as a subshell for logging.

# Use the one-line command for the bootstrap script. Assuming that the
# script has been properly configured, it should completely prepare
# the system for usage of a SUSE Manager server.

wget -O- http://proxy-or-sat.example.com/pub/bootstrap_script | /bin/bash

# The following is an example of rhnreg_ks usage, the kickstart
# utility for rhn_register. This demonstrates the usage of the 
# --activationkey flag, which describes an activation key. For example,
# this activation key could be set up in the Web interface to join this 
# system to the &quot;Laptops&quot; group and the local &quot;Laptop Software&quot; 
# channel. Note that this section applies only to Proxy server users, as this 
# step is handled by the Satellite bootstrap script. 
#
# For more information about activation keys, consult the SUSE Manager
# Reference Guide.

/usr/sbin/rhnreg_ks --activationkey=<replaceable>6c933ea74b9b002f3ac7eb99619d3374</replaceable>

# End the subshell and capture any output to a post-install log file.
) 1&gt;/root/post_install.log 2&gt;&amp;1</screen>
 </sect1>
 <!-- ==================================================================== -->
 <sect1 id="s1-rhnreg-ks-tracking">
  <title>Tracking Autoinstallations</title>
  <para>
   To track an autoinstallation, &susemgr; is creating a unique
   registration key for each autoinstallation. If a client uses that
   key to register, &susemgr; knows that the installation has
   finished successfully.
  </para>
  <para>
   If you upload a profile and want to track the
   installation, you need to use this tracking key when you register the client with
   &susemgr;. The key is stored in the
   <literal>$redhat_management_key</literal> variable of the profile.
   Use it like this (replace <replaceable>my_server_url</replaceable>
   with the address of your server):
  </para>
<screen>rhnreg_ks --serverUrl=<replaceable>my_server_url</replaceable> \
  --sslCACert=$mycert \
  --activationkey=<replaceable>1-my-sles11-sp1-key-i586</replaceable>,$redhat_management_key</screen>

  <para>
   The best way to achieve this is using the
   <literal>spacewalk/sles_register</literal> snippet like in the following
   example:
  </para>

  <screen><![CDATA[...
<scripts>
  <init-scripts config:type="list">
    <script>
      <source><![CDATA[
$SNIPPET('spacewalk/sles_register')
]]]]><![CDATA[>
      </source>
      <filename>ay_suse_manager_register.sh</filename>
      <debug config:type="boolean">true</debug>
    </script>
    ...
  </init-scripts>
  ...
</scripts>
...
]]></screen>

  <para>Integrate this init-script into the XML file you want to upload.
  The registration will be done automatically with the correct tracking key. For an example XML file, see <xref
  linkend="ap-sample-autoinst-tracking-script"/>. If you want to
  register the client with your own registration key in addition to the
  tracking key using this snippet, you must put the name of the key into the
  <literal>registration_key</literal> variable.  In the Web interface
  (<xref linkend="s4-sm-system-kick-details-variables"/>), click on
  <guimenu>Variables</guimenu> and, for example, enter:</para>

  <screen>registration_key=1-my-sles11-sp1-key-i586</screen>

  <para>This way the snippet will do the registration with your key in
  addition to the tracking key.</para>

  <para>To check the snippet, click <menuchoice>
  <guimenu>Systems</guimenu>
  <guimenu>Autoinstallation</guimenu>
  <guimenu>Kickstart Snippets</guimenu></menuchoice>. There you can find
  the <literal>sles_register</literal> snippet that will be included
  with the <literal>$SNIPPET('spacewalk/sles_register')</literal>
  statement as shown above in the XML fragment.</para>

  <para>If you use an uploaded profile without a tracking key, &susemgr;
  will never actually notice when the installation is finished. The
  machine will appear as a registered client but after some time
  &susemgr; will mark the installation as failed because the client did
  not register with the tracking key.
  </para>
 </sect1>
</chapter>
