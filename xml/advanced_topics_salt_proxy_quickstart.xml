<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook50-profile.xsl"
                 type="text/xml" 
                 title="Profiling step"?>
<!DOCTYPE chapter
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
    %entities;
]>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0"
    xml:id="advanced.topics.salt.proxy.quickstart">
    <title> Salt Proxy</title>
    <para/>
    <sect1>
        <title>Setup and Configuration</title>
        <para>Traditional proxy servers may now act as a broker and package cache for Salt minions.
            The following procedure will guide you through adding and configuring Salt proxy
            support.</para>

        <procedure>
            <title>Setup</title>
            <step>
                <para>For new proxies, make sure the <filename>spacewalk-proxy</filename> package
                    version 2.5.1.3 or later is installed. For previously existing proxies, update
                    the <filename>spacewalk-proxy</filename> packaged to version 2.5.1.3 or later.
                    The new salt-broker service will be automatically started at the end of the
                    package installation.</para>
                <note>
                    <title>Proxy Chains</title>
                    <para>It is possible to arrange salt proxies in a chain..</para>
                </note>
            </step>
            <step>
                <para>Make sure the proxies TCP ports <literal>4505</literal> and
                        <literal>4506</literal> are open and that the proxy can reach the SUSE
                    Manager server (or another upstream proxy) on these ports.</para>
            </step>
        </procedure>

        <procedure>
            <title>Configuration</title>
            <step>
                <para>To register a minion through a proxy, add the proxy FQDN as the master in the
                    minions configuration file located at:</para>
                <screen>/etc/salt/minion</screen>
                <para>or alternativly:</para>
                <screen>/etc/salt/minion.d/&lt;name&gt;.conf</screen>
            </step>
            <step>
                <para>Add the FQDN to the minion file:</para>
                <screen>master: proxy123.example.com</screen>
                <para> Save and restart the salt-minion service with:</para>
                <screen>systemctl restart salt-minion</screen>
            </step>
            <step>
                <para>Accept the new minion key via WebGUI or commandline:</para>
                <screen># salt-key -a 'minion'</screen>
                <para>The minion will now connect to the proxy exclusively for Salt operations and
                    normal HTTP package downloads.</para>
            </step>
        </procedure>
        <note>
            <title>WebGUI Information</title>
            <para>Within the WebGUI, standard proxy pages will show information about minions like
                normal clients. </para>

            <para>A list of all proxies is located under <guimenu>Systems</guimenu>
                <guimenu>Systems</guimenu>
                <guimenu>Proxy</guimenu>.</para>

            <para>A list of clients connected to a proxy can be located under
                    <guimenu>Systems</guimenu> &lt;proxy name&gt; <guimenu>Details</guimenu>
                <guimenu>Proxy</guimenu>. </para>
            <para>A list of chained proxies for a minion can be located under
                    <guimenu>Systems</guimenu> &lt;minion name&gt; <guimenu>Details</guimenu>
                <guimenu>Connection</guimenu></para>
        </note>
        <para>If you decide to move any of your minions between proxies or the server you will need
            to repeat the registration process from scrath.</para>

        <important>
            <title>Known Limitations</title>
            <para>The salt broker SUSE Manager Proxy functionality is only supported if the same SSL
                certificate generated for SUSE Manager Server was used when setting up the Proxy.
                Using different certificates for Proxies and Server is at the moment not supported.
            </para>
        </important>
    </sect1>
</chapter>
