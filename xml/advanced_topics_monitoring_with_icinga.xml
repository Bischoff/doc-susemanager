<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook50-profile.xsl"
                 type="text/xml" 
                 title="Profiling step"?>

<!DOCTYPE chapter[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
    %entities;
]>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0"
    xml:id="advanced.topics.monitoring.with.icinga">


    <title>Monitoring with Icinga</title>

    <sect1>
        <title>Introduction</title>
        <para>This chapter provides guidance on the setup of an Icinga server using SLES12 SP1. More
            information may be found within the Official Icinga documentation: <link
                xlink:href="http://docs.icinga.org/latest/en/"/></para>

    </sect1>

    <sect1>
        <title>Installation and Basic Configuration</title>
        <para>Icinga packages are found in the <literal>SLE-Manager-Tools12-Updates
            x86_64</literal>.</para>
        <tip>
            <title>Icinga Installation Location</title>
            <para>Do not install Icinga on the SUSE Manager server. Install Icinga on a stand-alone
                SLE client.</para>
        </tip>

        <procedure>
            <title>Installation and Basic Configuration</title>
            <step>
                <para>Register the monitoring server client with SUSE Manager and add the SUSE
                    Manager client and update channels. For both SLES12 and SLES12 SP1 these
                    channels are included by default.</para>
            </step>
            <step>
                <screen>zypper in icinga icinga-idoutils-pgsql postgresql postgresql94-server \
monitoring-plugins-all apache2</screen>
            </step>
            <step>
                <para>Edit the <literal>/etc/icinga/objects/contacts.cfg</literal> file and add the
                    email address which you will use for reciving alerts.</para>
                <screen>define contact{
        contact_name      icingaadmin         ; Short name of user
	use	          generic-contact     ; Inherit default values
        alias             Icinga Admin        ; Full name of user

        email             icinga@localhost    ; &lt;&lt;*** CHANGE THIS TO YOUR EMAIL ADDRESS ***
        }</screen>
            </step>
            <step>
                <para>Enable postgres on boot and start the database:</para>
                <screen>systemctl enable postgresql.service
systemctl start postgresql.service</screen>
            </step>
            <step>
                <para>Create the database and user for Icinga:</para>
                <screen>#su - postgres
 
 >psql
 postgres=# ALTER USER postgres WITH PASSWORD '&lt;newpassword&gt;';
 postgres=# CREATE USER icinga;
 postgres=# ALTER USER icinga WITH PASSWORD 'icinga';
 postgres=# CREATE DATABASE icinga;
 postgres=# GRANT ALL ON DATABASE icinga TO icinga;
 postgres=# \q
 exit</screen>
            </step>
            <step>
                <para>Adjust client authentication rights located in
                        <literal>/var/lib/pgsql/data/pg_hba.conf</literal> to match the
                    following:</para>
                <screen># TYPE  DATABASE        USER            ADDRESS                 METHOD
local   icinga         icinga                                  trust
local   all            postgres                                ident

# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            trust
# IPv6 local connections:
host    all             all             ::1/128                 trust
# Allow replication connections from localhost, by a user with the
# replication privilege.
#local   replication     postgres                                peer
#host    replication     postgres        127.0.0.1/32            ident
#host    replication     postgres        ::1/128                 ident
</screen>
                <important>
                    <title>Placement of Authentication Settings</title>
                    <para>Ensure your entry for local icinga authentication settings are placed
                        above all other local entries or you will get an error when configuring the
                        database schema. The entries in pg_hba.conf are read from top to
                        bottom.</para>
                </important>
            </step>
            <step>
                <para>Reload the Postgres service:</para>
                <screen>systemctl reload postgresql.service</screen>
            </step>
            <step>
                <para>Configure the database schema by running the following command in:
                        <literal>/usr/share/doc/packages/icinga-idoutils-pgsql/pgsql/</literal>:</para>
                <screen>psql -U icinga -d icinga &lt; pgsql.sql</screen>
            </step>
            <step>
                <para>Edit the following lines in <literal>/etc/icinga/ido2db.cfg</literal> to
                    switch from the default setting of mysql to postgres:</para>
                <screen>vi /etc/icinga/ido2db.cfg

 db_servertype=pgsql
 db_port=5432</screen>
                <tip>
                    <title>Open Firewall Port</title>
                    <para>Allow port <literal>5432</literal> through your firewall or you will be
                        unable to acces the WebGUI.</para>
                </tip>
            </step>
            <step>
                <para>Create an icinga admin account for logging into the web interface:</para>
                <screen>htpasswd -c /etc/icinga/htpasswd.users icingaadmin</screen>
            </step>
            <step>
                <para>Enable and start all required services:</para>
                <screen># systemctl enable icinga.service
# systemctl start icinga.service
# systemctl enable ido2db.service
# systemctl start ido2db.service
# systemctl enable apache2.service
# systemctl start apache2.service</screen>
            </step>
            <step>
                <para>Login to the WebGUI at: <link xlink:href="http://localhost/icinga"/>.</para>
            </step>
        </procedure>
        <para>This concludes setup and initial configuration of Icinga.</para>
    </sect1>


    <sect1>
        <title>Monitoring SUSE Manager with Icinga and NRPE</title>

        <para>The following section provides an overview on monitoring your SUSE Manager server
            using Icinga. You will add SUSE Manager as a host to Icinga and use a nagios
            script/plugin to monitor running services via <literal>NRPE</literal> (Nagios Remote
            Plugin Executor). This section does not attempt to cover all monitoring solutions Icinga
            has to offer but should help you get started.</para>

        <procedure>
            <title>Adding SUSE Manager to Icinga for Monitoring</title>
            <step>
                <para>On your SUSE Manager server install the required packages: </para>
                <screen>zypper install nagios-nrpe susemanager-nagios-plugin insserv nrpe</screen>
            </step>
            <step>
                <para>Modify the NRPE configuration file located at:</para>
                <screen>/etc/nrpe.cfg</screen>
                <para>Edit/add the following lines:</para>
                <screen>server_port=5666
nrpe_user=nagios
nrpe_group=nagios
allowed_hosts=Icinga.example.com
dont_blame_nrpe=1
command[check_systemd.sh]=/usr/lib/nagios/plugins/check_systemd.sh $ARG1$</screen>
                <para>Variable definitions:</para>
                <variablelist>
                    <varlistentry>
                        <term>server_port</term>
                        <listitem>
                            <para>The variable <literal>server_port</literal> defines the port nrpe
                                will listen on. The default port is 5666. This port must be opened
                                in your firewall.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>nrpe_user</term>
                        <listitem>
                            <para>The variables <literal>nrpe_user</literal> and
                                    <literal>nrpe_group</literal> control the user and group IDs
                                that nrpe will run under. SUSE Manager probes need access to the
                                database, therefore nrpe requires access to database credentials
                                stored in <filename>/etc/rhn/rhn.conf</filename>. There are multiple
                                ways to achieve this. You may add the user <literal>nagios</literal>
                                to the group <literal>www</literal> (this is already done for other
                                IDs such as tomcat); alternatively you can simply have nrpe run with
                                the effective group ID <literal>www</literal> in
                                    <filename>/etc/rhn/rhn.conf</filename>.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>allowed_hosts</term>
                        <listitem>
                            <para>The variable <literal>allowed_hosts</literal> defines which hosts
                                nrpe will accept connections from. Enter the FQDN or IP address of
                                your Icinga server here.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>dont_blame_nrpe</term>
                        <listitem>
                            <para>The use of variable <literal>dont_blame_nrpe</literal> is
                                unavoidable in this example. <literal>nrpe</literal> commands by
                                default will not allow arguments to be passed due to security
                                reasons. However, in this example you should pass the name of the
                                host you want information on to nrpe as an argument. This action is
                                only possible when setting the variable to 1.</para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>command[check_systemd.sh]</term>
                        <listitem>
                            <para>You need to define the command(s) that nrpe can run on SUSE
                                Manager. To add a new nrpe command specify a command call by adding
                                    <literal>command</literal> followed by square brackets
                                containing the actual nagios/icinga plugin name. Next define the
                                location of the script to be called on your SUSE Manager server.
                                Finally the variable <literal>$ARG1$</literal> will be replaced by
                                the actual host the Icinga server would like information about. In
                                the example above, the command is named
                                    <literal>check_systemd.sh</literal>. You can specify any name
                                you like but keep in mind the command name is the actual script
                                stored in <filename>/usr/lib/nagios/plugins/</filename> on your SUSE
                                Manager server. This name must also match your probe definition on
                                the Icinga server. <emphasis>This will be described in greater
                                    detail later in the chapter. The check_systemd.sh script/plugin
                                    will also be provided in a later section.</emphasis></para>
                        </listitem>
                    </varlistentry>
                </variablelist>
            </step>
            <step>
                <para/>
            </step>
        </procedure>
    </sect1>


    <sect1>
        <title>Adding Hosts to Icinga</title>
        <para/>
    </sect1>

    <sect1>
        <title>Adding Services</title>
        <para/>
    </sect1>

    <sect1>
        <title>Creating Hostgroups</title>
        <para/>
    </sect1>

    <sect1>
        <title>Creating Servicegroups</title>
        <para/>
    </sect1>

    <sect1>
        <title>Using the SUSE check_suma_patches Plugin</title>
        <para/>
    </sect1>

    <sect1>
        <title>Using the SUSE check_suma_lastevent Plugin</title>
        <para/>
    </sect1>




</chapter>
