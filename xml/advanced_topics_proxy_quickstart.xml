<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook50-profile.xsl"
                 type="text/xml" 
                 title="Profiling step"?>
<!DOCTYPE chapter
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
    %entities;
]>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="advanced.topics.proxy.quickstart">
 <title>&susemgrproxy; &productnumber3;</title>


 <para> This guide explains how to install and set up &susemgrproxy; &productnumber3;. </para>


 <sect1 xml:id="sec.manager.proxy.concepts">
  <title>Conceptual Overview</title>
  <para> &susemgrproxy; &productnumber3; is a &susemgr; add-on that caches software packages on an
   internal, central server. The proxy caches patch updates from &suse; or custom RPMs generated by
   third-party organizations. A proxy allows you to use bandwidth more effectively because client
   systems connect to the proxy for updates, and the &susemgr; server is no longer required to
   handle all client requests. The proxy also supports transparent custom package deployment. </para>

  <para> &susemgr; Proxy is an open source (GPLv2) solution that provides the following features: </para>

  <itemizedlist>
   <listitem>
    <para> Cache software packages within a Squid proxy. </para>
   </listitem>
   <listitem>
    <para> Client systems see the &susemgrproxy; as a &susemgr; server instance. </para>
   </listitem>
   <listitem>
    <para> The &susemgrproxy; is registered as a client system with the &susemgr; server. </para>
   </listitem>
  </itemizedlist>


  <para> The primary goal of a &susemgrproxy; is to improve &susemgr; performance by reducing
   bandwidth requirements and accelerating response time. </para>
 </sect1>

 <sect1 xml:id="sec.manager.proxy.requirements">
  <title>&susemgrproxy; &productnumber3; Requirements</title>
  <para> The following section provides &susemgrproxy; &productnumber3; requirements.</para>

  <formalpara>
   <title>Supported Client Systems</title>
   <para>For supported clients and their requirements, see: </para>
  </formalpara>
  <para><link linkend="mgr.supported.client.systems">Supported Client Systems</link></para>

  <formalpara>
   <title>Hardware Requirements</title>
   <para>Hardware requirements highly depend on your usage scenario. When planning proxy
    environments, consider the amount of data you wamt to cache on your proxy. If your proxy should
    be a 1:1 mirror of your &susemgr;, the same amount of disk space is required. For specific
    hardware requirements see: </para>
  </formalpara>
  <para><link linkend="quickstart.sect.software.requirements">Hardware Requirements</link></para>

  <formalpara>
   <title>Additional Requirements</title>
   <para>For additional network requirements see:</para>
  </formalpara>
  <para><link linkend="mgr.additional.requirements">Additional Network Requirements</link></para>
  <formalpara>
   <title>&scc;</title>
   <para>For using &susemgrproxy; &productnumber3;, you need an account at the &scc; (SCC) where
    your purchased products and product subscriptions are registered. Make sure you have the
    following subscriptions:</para>
  </formalpara>
  <itemizedlist>
   <listitem>
    <para> One or more subscriptions for &susemgrproxy;. </para>
   </listitem>
   <listitem>
    <para> One or more subscriptions for &susemgr;. </para>
   </listitem>
   <listitem>
    <para> Subscriptions for the products on the client systems you want to register with &susemgr;
     via &susemgrproxy;. </para>
   </listitem>
   <listitem>
    <para> Subscriptions to client entitlements for the client system you want to register with
     &susemgr; via &susemgrproxy;. </para>
   </listitem>
  </itemizedlist>


  <formalpara>
   <title>Network Time Protocol (NTP)</title>
   <para>The connection to the Web server via Secure Sockets Layer (SSL) requires correct time
    settings on the server, proxy and clients. For this reason, all systems must use NTP. See:
   </para>
  </formalpara>
  <para><link
    xlink:href="https://www.suse.com/documentation/sles-12/book_sle_admin/data/cha_netz_xntp.html"
    >Time Synchronization with NTP</link>
  </para>
  <formalpara>
   <title>Virtual Environments</title>
   <para> The following virtual environments are supported: </para>
  </formalpara>


  <para><link xlink:href="http://www.linux-kvm.org/page/Main_Page">&kvm;</link></para>

  <para>
   <link xlink:href="http://www.vmware.com/">&vmware;</link></para>

  <para><link xlink:href="http://www.microsoft.com/en-us/server-cloud/solutions/virtualization.aspx"
    >Hyper-V</link></para>



  <para>For running &susemgrproxy; in virtual environments, use the following settings for the
   virtual machine (VM):</para>

  <itemizedlist>
   <listitem>
    <para> At least 1 GB of RAM </para>
   </listitem>
   <listitem>
    <para> Bridged network </para>
   </listitem>
  </itemizedlist>



 </sect1>

 <sect1 xml:id="sec.manager.proxy.inst">
  <title>Installation and Setup</title>

  <para> Installing a &susemgrproxy; &productnumber3; system has been simplified in &susemgr; 3. The
   following section will guide you through this procedure. </para>

  <procedure xml:id="at.manager.proxy.install.prep">
   <title>Creating Your First Proxy</title>

   <step>
    <para>To register your client with &susemgr; &productnumber3; see: <link
      linkend="preparing.and.registering.clients">Preparing and Registering Clients</link>
    </para>
   </step>

   <step>
    <para>Once you have registered your client, direct your browser to the &susemgr; WebUI and
     login.</para>
   </step>

   <step>
    <para>Select the <guibutton>Systems</guibutton> tab and click on your newly registered system
     from the systems overview table.</para>
   </step>

   <step>
    <para>On the system's detail page select the <guibutton>Software</guibutton> tab then
      <guibutton>Software Channels</guibutton> tab.</para>
   </step>
   <step>
    <para>You will see a list of channels to which your client is already subscribed to. Select the
     two unchecked proxy channels which include the <systemitem>SUSE Manager
      Proxy-3.0-POOL</systemitem> and <systemitem>SUSE-Manager-Proxy-3.0-Updates</systemitem> then
     select <guibutton>Change Subscriptions</guibutton> to continue. This will provide the required
     repositories for the proxy packages from the &susemgr; Server to the client.</para>

    <note>
     <title>Unable to See the Proxy Channels?</title>
     <para>If you are unable to see the proxy child channels listed on your clients software
      channels subscription page, you have not synced the required packages from the
       <systemitem>Admin</systemitem>
      <systemitem>SUSE Products</systemitem> page. Select the proxy channel while executing the
      following procedure to ensure your client is provided with the correct channels and packages:
       <link linkend="quickstart.first.channel.sync">Providing Channels for Your Clients</link>
     </para>
    </note>
   </step>
   <step>
    <para>Select the <systemitem>Software</systemitem>, <systemitem>Packages</systemitem> tab and
     then <systemitem>Install New Packages</systemitem>.</para>
   </step>
   <step>
    <para>In <systemitem>patterns</systemitem> within the search field on the
      <systemitem>Installable Packages</systemitem> page. Select the Proxy pattern and then select
      <systemitem>Install Selected Packages</systemitem>.</para>
   </step>
   <step>
    <para>On the <systemitem>Confirm Package Install</systemitem> page select confirm to schedule
     the installation.</para>
   </step>

  </procedure>
  <para>The Proxy pattern will be installed and the client will be upgrade to a &susemgrproxy;. You
   may then register your clients against the proxy using a bootstrap script as if it were a
   &susemgr; Server and your clients will transparently request packages from the proxy instead of
   the server reducing bandwidth.</para>
 </sect1>

 <sect1 xml:id="sec.manager.proxy.inst.setup">
  <title>Generating a Bootstrap Script</title>
  <procedure xml:id="pro.manager.proxy.generate.bootstrap">
   <title>Generating the Bootstrap Script</title>
   <para> Several options in the bootstrap script can be set via the &susemgr; Web interface, for
    example, if remote command execution or remote configuration of proxy systems should be allowed. </para>
   <step>
    <para> On the &susemgr; Web interface, switch to the <guimenu>Admin</guimenu> tab and select <menuchoice>
      <guimenu>SUSE Manager Configuration</guimenu>
      <guimenu>Bootstrap Script</guimenu>
     </menuchoice>. </para>
   </step>
   <step xml:id="step.manager.proxy.bootstrap.options">
    <para> Check the options listed on the page and activate or deactivate them according to your
     needs. </para>
    <note>
     <title>Remote Command Execution and Configuration</title>
     <para> If you choose to <guimenu>Enable Remote Configuration</guimenu> or <guimenu>Enable
       Remote Commands</guimenu>, make sure that the <systemitem>rhncfg-actions</systemitem> package
      is installed on the proxy systems: </para>
     <orderedlist>
      <listitem>
       <para> Switch to the <guimenu>Systems</guimenu> tab and select <menuchoice>
         <guimenu>Activation Keys</guimenu>
        </menuchoice>. </para>
      </listitem>
      <listitem>
       <para> From the list of activation keys, click the one you want to modify. </para>
      </listitem>
      <listitem>
       <para> Click the <guimenu>Packages</guimenu> subtab, enter
         <systemitem>rhncfg-actions</systemitem> into the input field and click <guimenu>Update
         Key</guimenu>. </para>
      </listitem>
     </orderedlist>
     <para> The required package for remote command execution and configuration will automatically
      be installed on all systems registered with the respective activation key. </para>
    </note>
   </step>
   <step xml:id="step.manager.proxy.create.bootstrap">
    <para> Click the <guimenu>Update</guimenu> button. The necessary bootstrap script is generated
     and stored on the server's file system in the
      <filename>/srv/www/htdocs/pub/bootstrap</filename> directory. It is also available from
      <filename>https://susemanager.example.com/pub/bootstrap/</filename>. </para>
   </step>
   <step>
    <para> Proceed with the following procedure, <xref linkend="pro.manager.proxy.register"/>.
    </para>
   </step>
  </procedure>
  <procedure xml:id="pro.manager.proxy.register">
   <title>Editing the Bootstrap Script and Registering Proxy Systems</title>
   <para> Adjust the generated bootstrap script according to your needs. The minimal requirement is
    to include the activation key. We strongly recommend to also include one or more GPG keys (for
    example, your organization key, and package signing keys). Then execute the resulting script on
    each proxy system that you want to register with &susemgr; (either centrally from the &susemgr;
    server or decentralized on each system.) </para>

   <step>
    <para> Log in as &rootuser; to the &susemgr; server. </para>
   </step>
   <step>
    <para> Create a copy of the automatically generated script: </para>
    <screen><?dbsuse-fo font-size="0.85em"?>cd /srv/www/htdocs/pub/bootstrap
cp bootstrap.sh bootstrap-<replaceable>edited</replaceable>.sh</screen>
   </step>
   <step>
    <para> Edit the copy as follows: </para>
    <substeps>
     <step>
      <para> Search for the <varname>ACTIVATION_KEYS</varname> entry and enter the activation key.
       Make sure to also include the organization prefix in the key, for example: </para>
      <screen><?dbsuse-fo font-size="0.85em"?>ACTIVATION_KEYS=1-fef154ddcf0d515fc</screen>
     </step>
     <step>
      <para> Search for the <literal>ORG_GPG_KEY</literal> entry and enter one or more <remark>froh
        2014-04-24: same as manager_quick_config_i.xml:pro.manager.clients.register?</remark> GPG
       keys. Multiple keys must be entered as a comma-separated list. </para>
     </step>
     <step>
      <para> Adjust further parameters, if needed. For details, refer to the comments in
        <filename>bootstrap.sh</filename>. </para>
     </step>
     <step>
      <para> To enable the script for execution, remove the <literal>exit 1</literal> entry from the
       message block. The last lines of the message block should now read: </para>
      <screen>echo "the exit below)"
echo</screen>
     </step>
    </substeps>
   </step>
   <step>
    <para> Save the edited version of the script. </para>
   </step>
   <step>
    <para> Use one of the following possibilities to execute the edited script on all proxy machines
     that you want to register with &susemgr;: </para>
    <itemizedlist>
     <listitem>
      <para> Log in as &rootuser; on the &susemgr; server and execute the following commands: </para>
      <screen>cd /srv/www/htdocs/pub/bootstrap/
cat bootstrap-<replaceable>edited</replaceable>.sh | ssh \
root@<replaceable>client_hostname</replaceable> /bin/bash</screen>
     </listitem>
     <listitem>
      <para> Log in to each proxy client system and execute the following command (all on one line): </para>
      <screen><?dbsuse-fo font-size="0.85em"?>curl -Sks https://<replaceable>server_hostname</replaceable>/pub
/bootstrap/bootstrap-<replaceable>edited</replaceable>.sh | /bin/bash</screen>
     </listitem>
    </itemizedlist>
    <para> The proxy clients are registered with the &susemgr; server as specified in the bootstrap
     script. The &susemgr; Web interface shows the registered proxies as client systems on the
      <guimenu>Systems</guimenu> tab. </para>
   </step>
  </procedure>
  <remark>froh 2014-04-24: sync with manager_quick_config_i.xml?</remark>
  <note>
   <title>Missing <filename>repodata/repomd.xml</filename></title>
   <para> If the bootstrap script warns about missing <filename>repodata/repomd.xml</filename>,
    channel synchronizing is still running. Registration will succeed nevertheless, and thus package
    or patch updates will happen later as configured. </para>
   <para> To be on the save side, check on the Web interface when <guimenu>Repo Cache
     Status</guimenu> is <literal>Completed</literal>: Click <guimenu>Channels</guimenu>, then the
     <replaceable>Channel Name</replaceable> to see the <guimenu>Details</guimenu> page. Here you
    can check basic details, manager accounts, available patches and packages, as well as subscribed
    systems. </para>
  </note>
 </sect1>

 <sect1 xml:id="sec.manager.proxy.migrating">
  <title>Migrating from &susemgrproxy; 2.1 to &susemgrproxy; &productnumber3;</title>
  <para>Coming Soon!</para>
 </sect1>

 <sect1>
  <title>Registering Clients via &susemgrproxy;</title>

  <para> Registering clients via &susemgrproxy; is done almost the same way as registering clients
   directly with the &susemgr; server. The difference is that you create a bootstrap script on the
   &susemgrproxy; with a command-line tool. The bootstrap script then deploys all necessary
   information to the clients. The bootstrap script refers some parameters (such as activation keys
   or GPG keys) that depend on your specific setup. For background information, see the
   &mgrclientconfguide;. </para>

  <procedure>
   <step>
    <para> Create the client activation key on the &susemgr; server using the Web interface as
     explained in <!--  <xref linkend="sec.manager.config.setup.client"/> ADD LINK!-->. </para>
   </step>
   <step>
    <para> On the proxy, execute the <command>mgr-bootstrap</command> command-line tool as
     &rootuser;. If needed, either edit the resulting bootstrap script or use additional
     command-line switches such as <literal>--activation-keys</literal>: </para>
    <screen>mgr-bootstrap \
  --activation-keys=<replaceable>key-string</replaceable></screen>
   </step>
   <step>
    <para> Execute the bootstrap script on the clients as described in </para>
   </step>
  </procedure>

  <para> The clients are registered with the &susemgrproxy; specified in the bootstrap script. To
   check the status of the proxy connected client system, click the client system's details page on
   the &susemgr; Web interface (<menuchoice>
    <guimenu>Systems</guimenu>
   </menuchoice>, then select the system name). The <guimenu>Connection</guimenu> subtab displays
   the connection path to the client. </para>


 </sect1>

</chapter>
