<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook50-profile.xsl"
                 type="text/xml" 
                 title="Profiling step"?>
<!DOCTYPE chapter
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
    %entities;
]>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="bp.live.patching">
 <title>SLE Live Patching</title>
 <sect1>
  <title>Introduction</title>

  <para>
   Under normal circumstances a system needs to be rebooted after a
   kernel update. SLE Live Patching allows you skipping the reboot by
   applying a subset of Linux kernel releases injected via
   kGraft live patching technology.
  </para>

  <para>
   The following chapter will guide you through selecting the
   appropriate patches from a list of available CVE patches and cloning
   vendor channels using the
   <command>spacewalk-manage-channel-lifecycle</command> tool into
   <literal>testing</literal>, <literal>dev</literal> and
   <literal>prod</literal> channels. You will also learn how to use SLE
   Live Patching to avoid the typical reboot requirement after updating
   a system kernel. This chapter also provides a good example for
   maintaining environments using the
   <command>spacewalk-manage-channel-lifecycle</command> tool.
  </para>

  <para>
   For more information about using kGraft, see
   <link
       xlink:href="https://www.suse.com/documentation/sles-12/singlehtml/book_sle_admin/book_sle_admin.html#cha.kgraft"
       />.
  </para>
 </sect1>
 <sect1>
  <title>Initial Setup Requirements</title>

  <para>
   To work with SLE Live Patching the following expectations are assumed:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     SUSE Manager 3.0 or greater fully updated
    </para>
   </listitem>
   <listitem>
    <para>
     At least 1 Salt Minion running SLES12-SP2 and registered with SUSE manager
    </para>
   </listitem>
   <listitem>
    <para>
     The vendor channel for SLES12-SP2 including the SLE Live Patching child
     channel fully synced.
    </para>
   </listitem>
   <listitem>
    <para>
     spacewalk-utils package installed on SUSE Manager Server.
    </para>
<screen># zypper in spacewalk-utils</screen>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1>
  <title>Viewing Available CVE's</title>

  <para>
   The following procedure will guide you through selecting and viewing
   available CVE Patches (Common Vulnerabilities and Exposures) then applying
   these kernel updates using the new SLE Live Patching feature. In this example
   you will use the <command>spacewalk-manage-channel-lifecycle</command> tool
   to maintain specific channel states for testing, development and production.
  </para>

  <procedure>
   <step>
    <para>
     Select your SLES12 SP2 minion from the <guimenu>Systems</guimenu> page to
     view its <guimenu>System Details</guimenu>. Once you have added the SLES12
     SP2 Updates vendor child channel to your client, you should see several
     <literal>Critical</literal> software updates available. Click on
     <literal>Critical</literal> to see a list of available patches. Select any
     of these patches listed with the following synopsis: <emphasis>Important:
     Security update for the Linux kernel</emphasis>. All fixed security bugs
     will be listed along with their number. For example:(CVE-2016-8666)
    </para>
    <important>
     <title>Reboot Icon</title>
     <para>
      Normal or non-live kernel patches always require a reboot. In SUSE
      Manager these are represented by a <literal>Reboot Required</literal>
      icon located next to the <literal>Security</literal> shield icon.
     </para>
    </important>
   </step>
   <step>
    <para>
     You can search for individual CVE's by selecting the
     <guimenu>Audit</guimenu> tab from the navigation menu. Try searching for
     <literal>CVE-2016-8666</literal>. You will see that the patch is available
     in the vendor update channel and the systems it applies to will be listed.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1>
  <title>Cloning Channels</title>

  <para>
   It is considered best practice to clone a vendor channel that will be
   modified into a new channel with one of the following prefix names: (dev,
   testing, and prod). In the following procedure you will clone the default
   vendor channel into a new channel named
   <filename>dev-sles12-sp2-pool-x86_64</filename> using the command line.
  </para>

  <procedure>
   <step>
    <para>
     Open a terminal and as root enter:
    </para>
<screen># spacewalk-manage-channel-lifecycle --list-channels
Spacewalk Username: admin
Spacewalk Password: 
Channel tree:

 1. sles12-sp2-pool-x86_64
      \__ sle-live-patching12-pool-x86_64-sp2
      \__ sle-live-patching12-updates-x86_64-sp2
      \__ sle-manager-tools12-pool-x86_64-sp2
      \__ sle-manager-tools12-updates-x86_64-sp2
      \__ sles12-sp2-updates-x86_64  </screen>
   </step>
   <step>
    <para>
     Now use the <emphasis>--init</emphasis> argument to automatically create a
     new development clone of the original vendor channel:
    </para>
<screen>spacewalk-manage-channel-lifecycle --init -c sles12-sp2-pool-x86_64</screen>
   </step>
  </procedure>
 </sect1>
 <sect1>
  <title>Removing Kernel Patches</title>

  <para>
   In the following procedure you will remove all kernel patch updates located
   in the dev-sles12-sp2-updates-x86_64 channel that require a reboot.
  </para>

  <procedure>
   <step>
    <para>
     Check the current kernel version in use on your client:
    </para>
<screen># uname -r
3.12.62-60.64.8-default</screen>
   </step>
   <step>
    <para>
     From the SUSE Manager WebUI select <guimenu>Channels</guimenu>
     <guimenu>Manage Software Channels</guimenu>
     <guimenu>dev-sles12-sp2-updates-x86_64</guimenu>
     <guimenu>Patches</guimenu> <guimenu>List/Remove</guimenu>. Type
     <literal>kernel</literal> in the search field. Find the kernel version
     that matches the kernel in use on your minion.
    </para>
   </step>
   <step>
    <para>
     Remove all kernel update versions that are later than the current kernel.
    </para>
   </step>
   <step>
    <para>
     Your channel is now ready to promote for testing SLE Live Patching.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1>
  <title>Promoting Channels</title>

  <para>
   The following procedure will guide you through promoting and cloning a
   development channel to a testing channel. You will change the subscription
   to the dev repositories on your client to the new testing channel
   repositories. You will also add the SLE Live Patching child channels to your
   client.
  </para>

  <procedure>
   <step>
    <para>
     Promote and clone the <literal>dev-sles12-sp2-pool-x86_64</literal> to a
     new testing channel:
    </para>
<screen># spacewalk-manage-channel-lifecycle --promote -c dev-sles12-sp2-pool-x86_64</screen>
   </step>
   <step>
    <para>
     From the SUSE Manager WebUI under the <guimenu>Systems</guimenu> tab
     select your client system to view the <guimenu>System Details</guimenu>
     page. Select <guimenu>Software</guimenu> <guimenu>Software
     Channels</guimenu>. From the Software Channels page you can edit which
     channels a system is subscribed to. Select the new base software channel,
     in this case it should be <literal>test-sles12-sp2-pool-x86_64</literal>.
     Click the <guimenu>Confirm</guimenu> button to switch the Base Software
     Channel and finalize it by clicking the <guimenu>Modify Base Software
     Channel</guimenu> button.
    </para>
   </step>
   <step>
    <para>
     From the <guimenu>Software Channels</guimenu> page select and add both
     SLE Live Patching child channels by clicking the <guimenu>Change
     Subscriptions</guimenu> button.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1>
  <title>Installing kGraft Kernel Patches</title>

  <para>
   The following section will guide you through installing and enabling kGraft
   and utilizing kGraft patches.
  </para>

  <procedure>
   <step>
    <para>
     You will have to wait a moment for new channel meta-data to refresh. You
     can verify completion from the client with:
    </para>
<screen># zypper ref</screen>
   </step>
   <step>
    <para>
     You will now install the first kGraft patch on your client. Keep in mind
     the first kGraft patch will required a reboot of the system. All kGraft
     patches applied after the initial patch installation will not require a
     reboot. Using zypper search for the kgraft patch that matches your current
     kernel version. <literal>3.12.62-60.64.8-default</literal>
    </para>
<screen># zypper ref
# zypper se -s kgraft-patch-3.12.62-60.64.8-default
...
| kgraft-patch-3_12_62-60_64_8-default  | package | 3-2.1   | x86_64 | test-sle-live-patching12-updates-x86_64-sp2
| kgraft-patch-3_12_62-60_64_8-default  | package | 2-2.1   | x86_64 | test-sle-live-patching12-updates-x86_64-sp2
| kgraft-patch-3_12_62-60_64_8-default  | package | 1-2.2   | x86_64 | test-sle-live-patching12-updates-x86_64-sp2
...</screen>
   </step>
   <step>
    <para>
     Always install the lowest version of a kGraft patch. Keep in mind kGraft
     patches do not patch anything they only prepare the kernel for live
     patching. Install the lowest version of kGraft that matches your kernel:
    </para>
<screen># zypper in kgraft-patch-3_12_62-60_64_8-default-1-2.2</screen>
   </step>
   <step>
    <para>
     From the &susemgr; &webui; select <guimenu>Systems</guimenu> then select
     your client system. On the <guimenu>System Details</guimenu> page you will
     notice several things:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Under <literal>System Status</literal> The system requires a reboot to
       enable use of the kGraft live patching technology.
      </para>
     </listitem>
     <listitem>
      <para>
       Under <literal>System Info</literal> <literal>Kernel:</literal> You can
       see that <literal>Live patch: kgraft_patch_1_2_2</literal> has been
       applied.
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Reboot the client system.
    </para>
   </step>
   <step>
    <para>
     After the reboot bring your client system up to date by patching.
    </para>
   </step>
   <step>
    <para>
     On the <guimenu>System Details</guimenu> page you will notice the
     <literal>System Status</literal> message is <literal>System is up to
     date</literal> and under <literal>System Info Kernel:</literal> you will
     see the latest kGraft patch has been applied: <literal>Live patch:
     kgraft_patch_3_2_1</literal>.
    </para>
   </step>
  </procedure>

  <important>
   <title>CVE Availability</title>
   <para>
    Not all CVEs are included in live patches. Some CVEs require a system
    reboot and are therefore not included in the kgraft live patches. kGraft
    patches are always a subset of the full kernel patches.
   </para>
  </important>

 </sect1>
</chapter>
